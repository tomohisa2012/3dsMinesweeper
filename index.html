<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>3DS Minesweeper SE+HighScore</title>
<style>
body { background:#202020; color:white; font-family:Arial, monospace; text-align:center; }
#topbar { background:#c0c0c0; color:black; padding:5px; margin-bottom:5px; border:1px solid #808080; }
#boardWrapper { display:inline-block; background:#d0d0d0; padding:10px; border:2px solid #808080; }
#board table { border-collapse:collapse; margin:0 auto; }
#board td { width:24px; height:24px; border:1px solid #000; text-align:center; vertical-align:middle; font-weight:bold; cursor:pointer; }
td.revealed { background:#e0e0e0; color:black; cursor:default; }
td.mine { background:#ff4444; color:black; }
td.flag { background:#ffcc00; color:black; }
button { margin:2px; padding:4px 6px; font-size:12px; cursor:pointer; }
#flagButton.active { background-color:#ffcc00; color:black; }
#message { margin-top:5px; color:yellow; min-height:20px; }
#restartBtn { margin-top:5px; padding:5px 10px; display:none; cursor:pointer; }
#scoreboard { margin-top:5px; text-align:left; display:inline-block; background:#3a3a55; color:white; padding:5px; min-width:160px; }
</style>
</head>
<body>

<h2>3DS Minesweeper SE+HighScore</h2>
<div id="topbar">
Time: <span id="time">0</span>s &nbsp; Mines: <span id="mineCount">0</span>
<br>
<button onclick="setDifficulty('easy')">Easy</button>
<button onclick="setDifficulty('normal')">Normal</button>
<button onclick="setDifficulty('hard')">Hard</button>
<button id="flagButton" onclick="toggleFlag()">Flag Mode</button>
</div>

<div id="boardWrapper">
  <div id="board"></div>
  <div id="message"></div>
  <button id="restartBtn" onclick="init()">Restart</button>
  <div id="scoreboard"></div>
</div>

<audio id="clickSE" src="https://actions.google.com/sounds/v1/button/button_press.ogg"></audio>
<audio id="explodeSE" src="https://actions.google.com/sounds/v1/explosions/explosion.ogg"></audio>

<script>
var size=8, mines=10, board=[], flagsLeft=0, firstClick=true, gameEnded=false, flagMode=false;
var timer=0, interval=null, difficulty="easy";

function setDifficulty(level){
  difficulty=level;
  if(level==="easy"){ size=8; mines=10; }
  else if(level==="normal"){ size=12; mines=20; }
  else if(level==="hard"){ size=16; mines=40; }
  init();
}

function toggleFlag(){ flagMode=!flagMode; document.getElementById("flagButton").style.background=flagMode?"#ffcc00":"white"; }

function init(){
  clearInterval(interval);
  timer=0; firstClick=true; gameEnded=false; flagsLeft=mines;
  board=[];
  document.getElementById("time").innerText=timer;
  document.getElementById("mineCount").innerText=flagsLeft;
  document.getElementById("message").innerText=" ";
  document.getElementById("restartBtn").style.display="none";
  updateScoreboard();

  var boardDiv=document.getElementById("board");
  boardDiv.innerHTML="";
  var table=document.createElement("table");
  for(var i=0;i<size;i++){
    board[i]=[];
    var tr=document.createElement("tr");
    for(var j=0;j<size;j++){
      board[i][j]={mine:false,revealed:false,flag:false,count:0};
      var td=document.createElement("td");
      td.id="cell_"+i+"_"+j;
      td.setAttribute("data-x",i);
      td.setAttribute("data-y",j);
      td.onclick=function(){ clickCell(parseInt(this.getAttribute("data-x")),parseInt(this.getAttribute("data-y"))); };
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  boardDiv.appendChild(table);
}

function placeMines(safeX,safeY){
  var placed=0;
  while(placed<mines){
    var x=Math.floor(Math.random()*size);
    var y=Math.floor(Math.random()*size);
    if(Math.abs(x-safeX)<=1 && Math.abs(y-safeY)<=1) continue;
    if(!board[x][y].mine){ board[x][y].mine=true; placed++; }
  }
  for(var i=0;i<size;i++){ for(var j=0;j<size;j++){
    var count=0;
    for(var dx=-1;dx<=1;dx++){ for(var dy=-1;dy<=1;dy++){
      var nx=i+dx, ny=j+dy;
      if(nx>=0&&ny>=0&&nx<size&&ny<size && board[nx][ny].mine) count++;
    }}
    board[i][j].count=count;
  }}
}

function startTimer(){ interval=setInterval(function(){ if(gameEnded)return; timer++; document.getElementById("time").innerText=timer; },1000); }

function clickCell(x,y){
  if(gameEnded) return;
  var c=board[x][y];
  if(flagMode){
    if(!c.revealed){ c.flag=!c.flag; flagsLeft+=c.flag?-1:1; document.getElementById("mineCount").innerText=flagsLeft; drawBoard(); playSE('click'); }
    return;
  }
  if(c.revealed || c.flag) return;
  if(firstClick){ placeMines(x,y); firstClick=false; startTimer(); }
  revealCell(x,y);
  drawBoard();
  checkWin();
  playSE('click');
}

function revealCell(x,y){
  if(x<0||y<0||x>=size||y>=size) return;
  var c=board[x][y];
  if(c.revealed || c.flag) return;
  c.revealed=true;
  if(c.mine){ playSE('explode'); gameOver("ðŸ’¥ Game Over!"); return; }
  if(c.count==0){ for(var dx=-1;dx<=1;dx++){ for(var dy=-1;dy<=1;dy++){ if(dx!==0||dy!==0) revealCell(x+dx,y+dy); }}}
}

function drawBoard(){
  for(var i=0;i<size;i++){ for(var j=0;j<size;j++){
    var td=document.getElementById("cell_"+i+"_"+j);
    var c=board[i][j];
    td.className="";
    td.innerText="";
    if(c.revealed){
      if(c.mine){ td.className="mine"; td.innerText="X"; }
      else { td.className="revealed"; if(c.count>0) td.innerText=c.count; }
    } else if(c.flag){ td.className="flag"; td.innerText="F"; }
  }}
}

function checkWin(){
  var revealed=0;
  for(var i=0;i<size;i++){ for(var j=0;j<size;j++){ if(board[i][j].revealed) revealed++; } }
  if(revealed==size*size-mines){
    gameEnded=true; clearInterval(interval);
    document.getElementById("message").innerText="ðŸŽ‰ Cleared in "+timer+"s!";
    saveScore();
    updateScoreboard();
    document.getElementById("restartBtn").style.display="inline-block";
  }
}

function gameOver(msg){ gameEnded=true; clearInterval(interval); document.getElementById("message").innerText=msg; document.getElementById("restartBtn").style.display="inline-block"; }

function playSE(type){
  var se=null;
  if(type=='click') se=document.getElementById("clickSE");
  else if(type=='explode') se=document.getElementById("explodeSE");
  if(se){ se.currentTime=0; se.play(); }
}

// ãƒã‚¤ã‚¹ã‚³ã‚¢
function saveScore(){
  var key="ms_time_"+difficulty;
  var data=JSON.parse(localStorage.getItem(key))||[];
  data.push({time:timer});
  data.sort(function(a,b){return a.time-b.time;});
  data=data.slice(0,5);
  localStorage.setItem(key,JSON.stringify(data));
}

function updateScoreboard(){
  var key="ms_time_"+difficulty;
  var data=JSON.parse(localStorage.getItem(key))||[];
  var sb=document.getElementById("scoreboard");
  sb.innerHTML="<h3>"+difficulty.toUpperCase()+" Best Times</h3><ul>"+data.map(function(e){return "<li>"+e.time+"s</li>";}).join("")+"</ul>";
}

init();
</script>
</body>
</html>